/**
 * ASS Table Generator
 * Generates ASS dialogue lines for decorative table overlays
 * commonly used in anime fansub releases.
 */

import { ASS_CONFIG, TableSide } from "./constants";
import {
  TabelkaConfig,
  LogoConfig,
  validateTabelkaConfig,
  validateLogoConfig,
} from "./schemas";

// ============================================================================
// TYPES
// ============================================================================

export interface ScaledValues {
  scaleX: string;
  scaleY: string;
  posX: string;
  posY: string;
  posY1: string;
  posY2: string;
  posY3: string;
  posYTop: string;
  posYBottom: string;
  clipLeft: string;
  clipTop: string;
  clipRight: string;
  clipBottom: string;
}

// ============================================================================
// ASS TEMPLATE PARTS
// ============================================================================

/**
 * Rounded rectangle shape path for table background/border
 * This is the SVG-like path data used in ASS vector drawings
 */
const TABLE_SHAPE_PATH = String.raw`m 450 7.5 b 313.3 7.5 40 20 40 20 b 40 20 29.7 20.3 25 25 b 20.3 29.7 20 40 20 40 l 17.5 300 l 20 560 b 20 560 20.3 570.3 25 575 b 29.7 579.7 40 580 40 580 b 40 580 313.3 592.5 450 592.5 b 586.7 592.5 860 580 860 580 b 860 580 870.3 579.7 875 575 b 879.7 570.3 880 560 880 560 b 880 560 882.5 386.7 882.5 300 b 882.5 213.3 880 40 880 40 b 880 40 879.7 29.7 875 25 b 870.3 20.3 860 20 860 20 b 860 20 586.7 7.5 450 7.5`;

/**
 * Border decoration path (inner border with ornaments)
 */
const BORDER_DECORATION_PATH = String.raw`m 450 7.5 b 313.3 7.5 40 20 40 20 b 40 20 29.7 20.3 25 25 b 20.3 29.7 20 40 20 40 l 17.5 300 l 20 560 b 20 560 20.3 570.3 25 575 b 29.7 579.7 40 580 40 580 b 40 580 313.3 592.5 450 592.5 b 586.7 592.5 860 580 860 580 b 860 580 870.3 579.7 875 575 b 879.7 570.3 880 560 880 560 b 880 560 882.5 386.7 882.5 300 b 882.5 213.3 880 40 880 40 b 880 40 879.7 29.7 875 25 b 870.3 20.3 860 20 860 20 b 860 20 586.7 7.5 450 7.5 m 450 32.5 b 585 32.5 855 45 855 45 b 855 45 865.3 45.3 870 50 b 874.7 54.7 875 65 875 65 b 875 65 877.5 215 877.5 300 b 877.5 385 875 535 875 535 b 875 535 874.7 545.3 870 550 b 865.3 554.7 855 555 855 555 b 855 555 585 567.5 450 567.5 b 315 567.5 45 555 45 555 b 45 555 34.7 554.7 30 550 b 25.3 545.3 25 535 25 535 l 22.5 300 l 25 65 b 25 65 25.4 54.7 30.1 50 b 34.8 45.3 45 45 45 45 b 45 45 315 32.5 450 32.5 m 755 140 b 759.7 135.3 760 125 760 125 l 760 95 b 760 95 759.7 84.7 755 80 b 750.3 75.3 740 75 740 75 b 740 75 513 80.1 450 80 b 387 79.9 160 75 160 75 b 160 75 149.7 75.3 145 80 b 140.3 84.7 140 95 140 95 l 140 125 b 140 125 140.3 135.3 145 140 b 149.7 144.7 160 145 160 145 l 165 145 b 165 145 154.7 144.7 150 140 b 145.3 135.3 145 125 145 125 l 145 100 b 145 100 145.3 89.7 150 85 b 154.7 80.3 165 80 165 80 b 165 80 387 84.9 450 85 b 513 85.1 735 80 735 80 b 735 80 745.3 80.3 750 85 b 754.7 89.7 755 100 755 100 l 755 125 b 755 125 754.7 135.3 750 140 b 746.1 143.9 735 145 735 145 l 740 145 b 740 145 750.3 144.7 755 140 m 60 180 l 840 180 b 840 180 580 170 450 170 b 320 170 60 180 60 180 m 60 490 l 840 490 b 840 490 580 500 450 500 b 320 500 60 490 60 490`;

/**
 * Build a dialogue line for ASS
 */
function buildDialogueLine(params: {
  layer?: number;
  start: string;
  end: string;
  style: string;
  name: string;
  effect: string;
}): string {
  const { layer = 0, start, end, style, name, effect } = params;
  return `Dialogue: ${layer},${start},${end},${style},${name},0,0,0,,${effect}`;
}

/**
 * Build the fade effect tag
 */
function buildFadeEffect(): string {
  const { FADE_IN_START, FADE_IN_END, FADE_OUT_START, FADE_OUT_END } =
    ASS_CONFIG.TIMING;
  return String.raw`\fade(255,0,255,${FADE_IN_START},${FADE_IN_END},${FADE_OUT_START},${FADE_OUT_END})`;
}

/**
 * Build common positioning tags
 */
function buildPositionTags(scaled: ScaledValues, posY: string): string {
  return String.raw`\fscx${scaled.scaleX}\fscy${scaled.scaleY} \pos(${scaled.posX}, ${posY})`;
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Format a number with up to 2 decimal places
 */
function formatNumber(value: number): string {
  return value.toFixed(2).replace(/\.?0+$/, "");
}

/**
 * Calculate all scaled values based on resolution and side
 */
export function calculateScaledValues(
  width: number,
  height: number,
  isRight: boolean
): ScaledValues {
  const scale = height / ASS_CONFIG.BASE_HEIGHT;
  const widthDiff = ASS_CONFIG.BASE_WIDTH - width / scale;

  const basePosX = isRight
    ? ASS_CONFIG.BASE_POS_X_RIGHT_OFFSET - widthDiff
    : ASS_CONFIG.BASE_POS_X_LEFT;

  const baseClipLeft = isRight
    ? ASS_CONFIG.CLIP.RIGHT_START_OFFSET - widthDiff
    : ASS_CONFIG.CLIP.LEFT_START;
  const baseClipRight = isRight
    ? ASS_CONFIG.CLIP.RIGHT_END_OFFSET - widthDiff
    : ASS_CONFIG.CLIP.LEFT_END;

  return {
    scaleX: formatNumber(ASS_CONFIG.BASE_SCALE_X * scale),
    scaleY: formatNumber(ASS_CONFIG.BASE_SCALE_Y * scale),
    posX: formatNumber(basePosX * scale),
    posY: formatNumber(ASS_CONFIG.BASE_POS_Y * scale),
    posY1: formatNumber(ASS_CONFIG.BASE_POS_Y_TITLE * scale),
    posY2: formatNumber(ASS_CONFIG.BASE_POS_Y_CONTENT * scale),
    posY3: formatNumber(ASS_CONFIG.BASE_POS_Y_DESCRIPTION * scale),
    posYTop: formatNumber(ASS_CONFIG.BASE_POS_Y_TOP * scale),
    posYBottom: formatNumber(ASS_CONFIG.BASE_POS_Y_BOTTOM * scale),
    clipLeft: formatNumber(baseClipLeft * scale),
    clipTop: formatNumber(ASS_CONFIG.CLIP.TOP * scale),
    clipRight: formatNumber(baseClipRight * scale),
    clipBottom: formatNumber(ASS_CONFIG.CLIP.BOTTOM * scale),
  };
}

/**
 * Convert real newlines to ASS newline format (\\N)
 */
function convertToAssNewlines(text: string): string {
  return text
    .replace(/\r\n/g, "\\N")
    .replace(/\n/g, "\\N")
    .replace(/\r/g, "\\N");
}

/**
 * Strip ASS tags from text for display purposes
 */
export function stripAssTags(text: string): string {
  return text.replace(/\{[^}]*\}/g, "").trim();
}

/**
 * Extract plain text content from ASS-styled text
 */
export function extractPlainText(assText: string): string {
  return stripAssTags(assText)
    .replace(/\\N/g, "\n")
    .replace(/\\n/g, "\n")
    .replace(/\\h/g, " ");
}

// ============================================================================
// MAIN GENERATORS
// ============================================================================

/**
 * Generate the ASS dialogue lines for a table
 * @throws Error if config is invalid
 */
export function generateTabelka(config: TabelkaConfig): string {
  // Validate input
  const validation = validateTabelkaConfig(config);
  if (!validation.success) {
    throw new Error(`Invalid tabelka config: ${validation.error}`);
  }

  const isRight = config.side === TableSide.Right;
  const scaled = calculateScaledValues(config.width, config.height, isRight);
  const sideLabel = isRight ? "RIGHT" : "LEFT";
  const fade = buildFadeEffect();

  // Convert newlines in content
  const title = convertToAssNewlines(config.title);
  const content = convertToAssNewlines(config.content);
  const description = convertToAssNewlines(config.description);

  const { START, END } = ASS_CONFIG.TIMING;
  const baseName = `Tabelka - ${sideLabel} - ${config.groupName}`;

  // Build each dialogue line
  const lines: string[] = [];

  // Background layer
  lines.push(
    buildDialogueLine({
      start: START,
      end: END,
      style: "AnimeGate",
      name: `${baseName} - BG`,
      effect: String.raw`{\an5 ${buildPositionTags(scaled, scaled.posY)} \1c&HE5F8FD&\1a&H80&\3a&HFF&\shad0\p1${fade}}${TABLE_SHAPE_PATH} {\p0}`,
    })
  );

  // Border layer
  lines.push(
    buildDialogueLine({
      start: START,
      end: END,
      style: "AnimeGate",
      name: `${baseName} - Border`,
      effect: String.raw`{\an5 ${buildPositionTags(scaled, scaled.posY)} \1c&H522E2A&\1a&H3F&\3a&HFF&\shad0\p1${fade}}${BORDER_DECORATION_PATH} {\p0}`,
    })
  );

  // Title layer
  lines.push(
    buildDialogueLine({
      start: START,
      end: END,
      style: "AnimeGate",
      name: `${baseName} - Title`,
      effect: String.raw`{\an5 ${buildPositionTags(scaled, scaled.posY1)} ${fade} \bord2} ${title}`,
    })
  );

  // Content layer - handle special \move() case
  const hasMove = content.includes("\\move(");
  const contentPos = hasMove ? "" : String.raw`\pos(${scaled.posX}, ${scaled.posY2})`;
  const contentScale = hasMove
    ? String.raw`\fscx${scaled.scaleX}\fscy${scaled.scaleY}`
    : buildPositionTags(scaled, scaled.posY2);

  lines.push(
    buildDialogueLine({
      start: START,
      end: END,
      style: "AnimeGate",
      name: `${baseName} - Content`,
      effect: String.raw`{\an5 ${contentScale} \clip(${scaled.clipLeft}, ${scaled.clipTop}, ${scaled.clipRight}, ${scaled.clipBottom}) ${fade}\bord2} ${content}`,
    })
  );

  // Description layer
  lines.push(
    buildDialogueLine({
      start: START,
      end: END,
      style: "AnimeGate",
      name: `${baseName} - DSC`,
      effect: String.raw`{\an5 ${buildPositionTags(scaled, scaled.posY3)} ${fade} \bord2} ${description}`,
    })
  );

  return lines.join("\n");
}

// ============================================================================
// LOGO GENERATOR
// ============================================================================

/**
 * AnimeGATE Logo SVG path data
 */
const LOGO_SVG_PATH = `{\\1a&HD0&\\1c&HE5F8FD&} m 1579.8 489.4 b 1579.8 358.9 1634.7 218.8 1727 126.5 b 1819.2 34.3 1959.3 -20.6 2089.8 -20.6 b 2220.4 -20.6 2360.4 34.3 2452.7 126.5 b 2545 218.8 2599.8 358.9 2599.8 489.4 b 2599.8 620 2545 760 2452.7 852.3 b 2360.4 944.6 2220.4 999.4 2089.8 999.4 b 1959.3 999.4 1819.2 944.6 1727 852.3 b 1634.7 760 1579.8 620 1579.8 489.4  {\\1a&HA0&\\1c&H230C09&} m 539.8 529.4 b 539.8 393.8 596.8 248.2 692.7 152.3 b 788.6 56.4 934.2 -0.6 1069.8 -0.6 b 1205.5 -0.6 1351 56.4 1447 152.3 b 1542.9 248.2 1599.8 393.8 1599.8 529.4 b 1599.8 665.1 1542.9 810.6 1447 906.5 b 1351 1002.5 1205.5 1059.4 1069.8 1059.4 b 934.2 1059.4 788.6 1002.5 692.7 906.5 b 596.8 810.6 539.8 665.1 539.8 529.4 m 707 892.3 b 799.2 984.6 939.3 1039.4 1069.8 1039.4 b 1200.4 1039.4 1340.4 984.6 1432.7 892.3 b 1525 800 1579.8 660 1579.8 529.4 b 1579.8 398.9 1525 258.8 1432.7 166.5 b 1340.4 74.3 1200.4 19.4 1069.8 19.4 b 939.3 19.4 799.2 74.3 707 166.5 b 614.7 258.8 559.8 398.9 559.8 529.4 b 559.8 660 614.7 800 707 892.3 {\\1c&H522E2A&} m -324.6 783.9 b -239.5 868.9 -110.5 919.4 9.8 919.4 b 130.1 919.4 259.2 868.9 344.3 783.9 b 429.3 698.8 479.8 569.7 479.8 449.4 b 479.8 329.1 429.3 200.1 344.3 115 b 259.2 30 130.1 -20.6 9.8 -20.6 b -110.5 -20.6 -239.5 30 -324.6 115 b -409.6 200.1 -460.2 329.1 -460.2 449.4 b -460.2 569.7 -409.6 698.8 -324.6 783.9 m -480.1 449.5 b -480.1 324.1 -427.4 189.5 -338.8 100.8 b -250.1 12.2 -115.5 -40.5 9.9 -40.5 b 135.3 -40.5 269.9 12.2 358.6 100.8 b 447.2 189.5 499.9 324.1 499.9 449.5 b 499.9 574.9 447.2 709.5 358.6 798.1 b 269.9 886.8 135.3 939.5 9.9 939.5 b -115.5 939.5 -250.1 886.8 -338.8 798.1 b -427.4 709.5 -480.1 574.9 -480.1 449.5 {\\1c&H8D835F&} m -1145.2 390.5 b -1148.1 388.3 -1150.9 386.1 -1153.7 383.8 b -1152.6 383.9 -1147.1 384.7 -1145.6 385.1 b -1145.4 386.7 -1145.3 389.5 -1145.2 390.5 m -1118.7 366.4 b -1119.4 360.5 -1120.4 351.9 -1120.5 348.3 b -1112.6 352.6 -1107.3 357.5 -1105 359.2 b -1104.5 363.9 -1103.6 367.7 -1105.1 369.8 b -1106.9 371.4 -1113.9 368.3 -1118.7 366.4 m -1103.5 417 b -1108.5 414.4 -1113.3 411.6 -1118.1 408.8 b -1117.9 405.2 -1118.3 396 -1118.9 392 b -1111.9 394.2 -1107.8 395.3 -1103.6 397 b -1103.3 403.7 -1103.7 414.1 -1103.5 417 m -1075.2 371.9 b -1081.3 360.4 -1088.7 352.2 -1096.3 345.1 b -1102.9 339 -1116.2 330.7 -1123.5 329 b -1124.7 323.5 -1129.2 303.1 -1131.8 293.2 b -1124.4 297.6 -1106 314.3 -1091.1 329.9 b -1071.1 350.9 -1066.8 366.2 -1063.3 379 b -1059.3 393.8 -1059.3 432 -1059.1 436.4 b -1060.1 436 -1061.1 435.6 -1062.2 435.3 b -1063.6 423.8 -1063.5 405.4 -1065.9 397.1 b -1068.3 388.3 -1070.7 380.2 -1075.2 371.9 m -1146.5 361.4 b -1151.4 360.7 -1168 357.9 -1180.7 357.7 b -1190.4 347 -1199.3 335.6 -1207.4 323.6 b -1203.8 324 -1158.8 330.5 -1152.1 335.6 b -1149.5 338.5 -1147.4 353.7 -1146.5 361.4 m -1273.4 19.7 b -1273.1 -15.7 -1311 -16.4 -1337.4 -21.9 b -1333.9 0.8 -1321.4 16 -1312.1 24.8 b -1294.5 15.4 -1289.7 15.4 -1273.4 19.7 m -730.8 172.8 b -732.1 175.8 -733.5 178.7 -734 181.6 b -734.5 184.6 -734.7 187.8 -733.9 190.3 b -733 192.8 -731.9 193.9 -729.7 196 b -727.4 198.1 -723.1 200.9 -720 202.3 b -717.1 199.9 -716 194.9 -715.5 190.9 b -715 186.9 -716.1 182.2 -717 179 b -718 175.8 -719.1 174.3 -720.4 171.9 b -720.6 171.6 -724.4 165.3 -725.3 164.2 b -726.9 166 -729.5 169.9 -730.8 172.8 m -702.9 122.9 b -708.7 118 -712.4 112.9 -717 106.6 b -721.4 110.5 -727.4 118.1 -729.9 125.2 b -732.1 132.4 -732.5 140.8 -731.5 147.3 b -728.8 155.6 -722.5 160 -714.2 163.4 b -705.6 166.7 -702.2 169.3 -697.3 171.7 b -695.8 165.9 -693.7 160.1 -693.1 156.3 b -692.3 149.7 -691.1 145.7 -692 140 b -693.6 133.5 -697.6 127.6 -702.9 122.9 m -816.9 367.3 b -818.6 369 -825.7 371.7 -828.7 372.6 b -828.8 366.6 -829.9 363.4 -828.6 359.8 b -827.4 356.3 -819 352.6 -815.6 350.7 b -815.6 353.2 -816 366.3 -816.9 367.3 m -817.2 405.8 b -822.3 408.9 -826.2 411.9 -828.9 413.7 b -828.9 407.6 -828.7 402.3 -828.7 395.5 b -824.9 394 -822.3 393.5 -817.5 391.2 b -817.3 395 -817.5 401.1 -817.2 405.8 m -793.1 392.9 b -793.3 390.8 -793.3 389.1 -793.1 385.7 b -786 384.9 -779 383.3 -775.7 382.7 b -779.7 387.4 -784.8 391.6 -793.1 392.9 m -757.8 353.1 b -771.8 355.2 -783.7 359.7 -789 360.1 b -789.3 352.4 -787.1 341.7 -784.6 334.2 b -767.3 326.4 -742.5 324.1 -734.3 322.3 b -741.5 333 -749.4 343.3 -757.8 353.1 m -812.9 331.1 b -820.5 336 -827.9 339.9 -834.9 345.9 b -841.8 351.9 -849.1 359.1 -854.8 368 b -860.6 377 -865.1 388.4 -868.2 399.6 b -873 416.7 -871.9 430.9 -873.5 433.5 b -876.7 432.2 -876.7 410.1 -874.5 394.1 b -873.1 383.2 -870.4 372.3 -866 362.2 b -861.4 351.6 -855 341.6 -847.6 332.7 b -835.3 317.9 -820.2 305.6 -805 293.7 b -807.4 301.9 -811.6 327.1 -812.9 331.1 m -789.1 -48.4 b -812.8 -41.1 -837.2 -34.1 -873.5 -15.5 b -845.9 -24.4 -798.3 -31.9 -770.2 -31.2 b -751 -12 -734 11.8 -720.5 37.4 b -706.8 31 -692.1 25.4 -679.3 20.6 b -692.9 -5.3 -708.9 -29.3 -728.4 -48.9 b -735.7 -52.7 -790.8 -49.9 -789.1 -48.4 m -1200.2 -61.2 b -1231.5 -29.9 -1250.1 4.7 -1257.5 23.8 b -1252.6 21.6 -1246.6 19.5 -1236.6 19.9 b -1227.2 20.3 -1223.5 23 -1219.8 25.2 b -1205.3 5.7 -1192.6 -9.5 -1170.2 -31.2 b -1118.9 -82.5 -1053.6 -115.7 -984 -90.6 b -960.1 -82 -943.4 -47.6 -893.8 -47.8 b -854 -47.2 -817.7 -70.9 -807.1 -110.2 b -804.5 -127.7 -805.8 -140.9 -810.6 -154.8 b -814.4 -165.8 -827.3 -180.1 -830.7 -181.8 b -833 -178.5 -844 -153.1 -843.9 -137.6 b -843.9 -137 -860.2 -145.3 -875.3 -151.4 b -890.4 -157.5 -904.5 -160.1 -912.8 -163.6 b -913.7 -164 -868 -186.1 -856.3 -191.4 b -866.6 -195.5 -920.8 -195.9 -936.3 -195.3 b -956.5 -194.5 -980.7 -184.2 -990.8 -181.5 b -998.7 -179.3 -1028 -163.2 -1041.7 -155.4 b -1049.6 -151 -1078.6 -131.7 -1084.2 -128.8 b -1086.6 -127.6 -1100.6 -123.6 -1119.7 -114.2 b -1146.5 -100.9 -1182.3 -79.1 -1200.2 -61.2 m -977.8 -145.9 b -958.7 -151.6 -939.1 -147.7 -923.1 -145.7 b -909.3 -143.9 -899.4 -141.9 -880.5 -136.6 b -861.5 -131.4 -847.8 -122.9 -846.5 -121 b -854 -120 -859.3 -124.3 -872.7 -124.8 b -886.2 -125.3 -899.2 -125.7 -911.5 -120.4 b -930.7 -112 -931.2 -100.9 -929.4 -92.4 b -922.4 -97 -916.4 -107.9 -886.1 -106.5 b -856.1 -105.2 -846.9 -92 -848.1 -84.4 b -850.1 -71.4 -874.4 -64.6 -890.2 -65.2 b -909.1 -65.8 -932.8 -74.4 -939.6 -92.7 b -944.3 -105.5 -960.4 -114.2 -968.7 -119 b -975.3 -122.8 -998.7 -133.8 -1005.2 -134.6 b -1000 -139.8 -983.1 -144.3 -977.8 -145.9 m -809.5 -72.1 b -801.6 -67.3 -794 -62.1 -787 -56.5 b -781.2 -57.4 -752.6 -62.4 -737.4 -58.8 b -753.8 -75.3 -780.8 -95.6 -793.3 -103.4 b -796.1 -96.1 -811.1 -73.1 -809.5 -72.1 m -1066.5 86.2 b -1066.6 78.1 -1068 71.4 -1064.2 67.2 b -1060.9 63.4 -994.9 65.8 -988.3 65.9 b -988 73.5 -988.2 79.7 -987.9 86.7 b -1003.7 86.6 -1054.8 85.7 -1066.5 86.2 m -868.1 110.9 b -867.7 166.7 -867.8 265 -868 317.5 b -875.9 328.4 -881.2 341.1 -886.2 353.6 b -890.6 364.7 -894.8 376.1 -896.5 387.9 b -900.9 419.2 -894.9 482.2 -895.4 482.8 b -836.7 469.5 -781.4 440.1 -740.2 398.8 b -732.8 391.4 -725.8 383.5 -719.1 375.3 b -716.4 378.4 -701.4 384.5 -689.3 382.1 b -678.3 379.9 -666 373.8 -656.8 364 b -660.9 362 -667 359.3 -679.1 357.8 b -688.4 356.7 -700.2 356.6 -705.4 356.9 b -691 336.2 -679.1 313.5 -669.7 289.8 b -687.1 293.4 -712.3 299.8 -721.5 301.6 b -730.8 303.5 -773.3 313.7 -781 314.8 b -780 308.2 -773.5 276.7 -771.3 272.3 b -754.5 257.6 -735.5 246.6 -727.6 242.3 b -719.8 238 -685 222.1 -676.6 219.3 b -668.1 216.5 -615.1 205.9 -607.4 206.6 b -615.7 217.3 -647.7 238.7 -655.5 243.5 b -663.4 248.3 -699.6 267.1 -706.7 270.2 b -713.9 273.4 -743.7 289.4 -746.9 293.6 b -740.3 294.3 -719 287.2 -713.9 286.4 b -697.5 282.9 -676 275.9 -664.3 271.9 b -658.9 270.2 -619.8 248.6 -619.8 248.6 b -619.8 248.6 -592.3 230.1 -585.5 223.3 b -573.1 211 -553.7 190.1 -544.8 176.7 b -558.8 176.8 -587.4 180.8 -600.3 180.4 b -612.4 181.2 -651.5 184.6 -655.9 186.1 b -653.5 180.7 -647.2 155.2 -646.7 149.9 b -645.4 134.4 -649.3 109.3 -648.8 94.5 b -648.5 83.6 -643.6 71 -633.3 66.6 b -622.9 62.3 -614 60.5 -607.4 56.6 b -604.3 75.7 -616.5 103.4 -632.5 112.6 b -631.6 117.3 -630.8 122.2 -631.1 125.8 b -614.2 119.9 -603.6 108.5 -595.9 90.6 b -585.6 66.9 -586.4 38.2 -590.5 19.4 b -609.9 35.9 -623.2 41.1 -635.6 45.5 b -660.5 54.3 -666 75.2 -666.6 80.8 b -669.2 102.5 -671.3 123.9 -676.9 141.3 b -682.2 152.8 -691 171.6 -694.7 177.1 b -700.3 185.6 -706.8 193.7 -714.2 200.6 b -719 205.2 -726.8 209.8 -730.3 212.3 b -730.1 209.6 -730.8 207.2 -731.7 204.8 b -733 201.4 -735.4 198.5 -737.5 195.5 b -740.6 191 -743.4 185.5 -747.2 182.2 b -750.6 190.6 -755 199.8 -755.7 208.4 b -755.4 214.5 -753.9 222.6 -749.5 224.5 b -758.9 231.5 -774.8 239.1 -787.2 247.3 b -801.6 257 -816.5 267.2 -829.6 278.5 b -829.6 278.5 -816.2 253.8 -815.1 252.3 b -814 250.8 -791.6 198.3 -777 172.2 b -762.3 146.1 -745.5 115 -727.6 96.2 b -709.6 77.4 -687.6 68.2 -674.6 58.1 b -661.7 47.9 -655.6 43.1 -649.2 36.4 b -669.2 34.6 -676.2 35.4 -692.6 42 b -708.9 48.5 -723.9 59.1 -742.5 78.6 b -761.1 98.2 -782.3 134.4 -797.5 162.1 b -812.7 189.8 -821.1 213.6 -834.2 244 b -834.3 211 -835.1 141.2 -835 110.8 b -826 111.4 -820 111.1 -812.2 110.9 b -809.7 105.1 -809.8 91.5 -812.1 86.9 b -817.6 85.9 -828.4 87.3 -836.1 86.6 b -835.8 79.3 -835.2 73.8 -835.3 65.9 b -825.8 66.1 -810.9 66.4 -802.1 65 b -800.5 60.1 -800.6 57.8 -801.6 55.8 b -796.9 55.4 -787.6 55 -777.3 53.6 b -756.3 32.1 -748.9 21.6 -744.4 4.2 b -763.3 7.1 -828.2 14.2 -865.6 16.5 b -903 18.8 -933.1 18.9 -968.5 18.8 b -1004 18.7 -1040.9 17.9 -1078.2 15.8 b -1115.4 13.6 -1154.3 10.9 -1191.9 5.7 b -1180.5 33.4 -1169 41.5 -1155.2 53.9 b -1149.2 55.1 -1138.5 54.6 -1133.5 53.9 b -1134.7 55.9 -1134.4 60 -1132.2 65.6 b -1118.5 65.4 -1111.9 64.9 -1100.2 64.8 b -1100.5 72.3 -1100.2 79.4 -1100.4 86.6 b -1107.6 86.7 -1114.9 86.7 -1123.7 86.6 b -1126.1 95.7 -1125.7 103 -1124.5 110.4 b -1114 110.8 -1109.9 110.5 -1100.7 110.6 b -1100.2 139.4 -1100.2 215.9 -1100.9 253.2 b -1107.4 240.7 -1112.3 229.1 -1119.7 214.9 b -1127.1 200.6 -1135.6 183 -1144.3 167.8 b -1153.1 152.6 -1162.3 137 -1172.4 123.6 b -1169 135.4 -1159.9 158.8 -1153.4 175.1 b -1146.9 191.4 -1137.8 212.2 -1133.5 221.2 b -1129.5 228.5 -1107.5 267.4 -1103.2 279.5 b -1110.1 274.6 -1145.8 249.4 -1157.2 243.5 b -1164 240.1 -1180.3 229.4 -1188.8 226.6 b -1183.9 222 -1181.9 218.8 -1181.3 211.1 b -1181.2 209.2 -1182.2 204.1 -1184.3 198.9 b -1187 192 -1191.1 184.7 -1192.6 182.1 b -1194.2 184 -1199.6 190.3 -1203.5 196.4 b -1206.5 201 -1208.4 205.5 -1209 207.4 b -1216.7 201.1 -1230.1 196.4 -1252.2 197.6 b -1258.9 197.8 -1266.7 196.5 -1274.6 192.2 b -1274.4 194.9 -1271.1 199.8 -1268.3 202.1 b -1279.2 203.3 -1287.6 203.6 -1293.7 204 b -1313.4 205.2 -1331.8 210.1 -1340.5 212.6 b -1355.5 217.2 -1370.5 227.3 -1382.2 237.3 b -1402.2 254.4 -1413.6 283.5 -1414.3 290.8 b -1409.5 283.8 -1387.5 268.4 -1368.5 258.4 b -1359 253.4 -1347.8 248.6 -1329.5 244.3 b -1312.1 240.3 -1293.1 238.2 -1287 238.1 b -1280.9 238 -1260.8 238.1 -1246.1 240 b -1231.4 241.9 -1211.7 250.2 -1205.1 252.5 b -1190.2 257.6 -1168.1 271.2 -1163.3 274.3 b -1160.3 280.9 -1156 305.5 -1154.4 315.2 b -1164.2 312.6 -1211.9 304 -1219.4 304.1 b -1225.1 293.9 -1230.3 283.4 -1234.7 272.5 b -1215.1 273.6 -1190 279.9 -1178.8 283.3 b -1184.8 275.2 -1219.6 263.5 -1237.3 261.1 b -1255 258.8 -1270.6 258.3 -1281.7 258.8 b -1292.7 259.4 -1313.9 265.5 -1317.7 269.9 b -1311.5 269.5 -1287.7 267.8 -1278.7 268.4 b -1268.1 300.9 -1252.6 332 -1233.1 359.5 b -1237.4 357.6 -1246.6 356.1 -1255 356.4 b -1269 357 -1283.4 360.9 -1288.3 364.4 b -1283.1 368.4 -1268.3 377.6 -1255.5 380.8 b -1240.5 384.5 -1223.8 377.8 -1220.9 375.7 b -1214.3 383.8 -1207.4 391.5 -1200.2 398.8 b -1157.4 441.5 -1095.9 472.1 -1035.2 485.8 l -1035.2 443.8 b -1035.4 434.3 -1036.1 383.9 -1039.5 370.5 b -1042.2 360 -1059.8 327.3 -1066.1 313.1 b -1066 292.7 -1066.8 173.9 -1067.9 110.6 b -1013.7 111.5 -924 110.7 -868.1 110.9 m -1258.1 -74.4 b -1265.5 -47.9 -1270.7 -25 -1245.3 -8.6 b -1226.5 -33.4 -1227.9 -56.8 -1258.1 -74.4 m -1177.7 -157.5 b -1182.4 -153.8 -1204 -130.9 -1208.8 -112.4 b -1211.1 -102.1 -1208.8 -88.9 -1202.1 -67.7 b -1187.8 -78.9 -1168.7 -89.5 -1164.8 -103.9 b -1161.3 -126.4 -1169.5 -137.5 -1177.7 -157.5 m -743.7 -154.8 b -752.6 -146 -764 -119.7 -762.8 -107.8 b -760.9 -88.2 -740.8 -75.4 -726.8 -68.6 b -721.3 -83.8 -717.7 -102.3 -721.1 -112.3 b -725.8 -126.3 -737.5 -146.7 -743.7 -154.8 m -689.5 -8 b -681.7 -14.3 -674.6 -19.4 -673 -28.3 b -669.9 -45.3 -669.7 -64.5 -672.3 -73.5 b -685.5 -69.4 -696.8 -60.7 -700 -49.4 b -703.8 -36.3 -697.8 -20 -689.5 -8 m -604.5 -24.2 b -610.7 -25.9 -637.1 -22.2 -651.5 -17 b -664.9 -12.1 -664.7 3.6 -665.9 14.3 b -649.9 14.7 -644.9 15.8 -635.4 18.3 b -623.4 11 -609.3 -9.1 -604.5 -24.2 m -946.9 86.3 b -947 78.1 -947.4 73.5 -947.2 66 b -939.6 65.8 -875.2 63.5 -870.8 67 b -866.4 70.5 -867.3 79.4 -867.5 86.8 b -883.3 86.8 -935.2 85.7 -946.9 86.3 {\\1c&HBAA34F&} m -2151.2 -500.3 b -2153.5 -502.6 -2168.1 -503.4 -2165.7 -512.1 b -2163.3 -520.9 -2149.4 -512.3 -2144.3 -511.5 b -2145.8 -517.9 -2152.6 -529 -2144.6 -532.1 b -2136.5 -535.2 -2134.7 -519.8 -2133.2 -515.7 b -2130.9 -520 -2128 -534.5 -2120.2 -531.6 b -2112.5 -528.7 -2120.4 -516 -2122.3 -510.9 b -2117.4 -512.9 -2101.7 -520.2 -2099.6 -512.4 b -2097.5 -504.6 -2112.6 -501.7 -2117 -500.6 b -2113.2 -498.3 -2097.6 -494.4 -2101.2 -486.3 b -2104.7 -478.2 -2116.3 -488.7 -2121 -489.8 b -2119.1 -484.5 -2113.1 -472.2 -2120.9 -469.4 b -2128.7 -466.6 -2130.5 -481.1 -2132.9 -485.3 b -2134.9 -480.9 -2135.7 -467.7 -2144.2 -470 b -2152.6 -472.4 -2145.8 -486 -2144.6 -489.5 b -2147.7 -488.1 -2161.8 -479.1 -2164.8 -486.8 b -2167.8 -494.6 -2154.4 -499.1 -2151.2 -500.3 m -2133 -494.8 b -2129.4 -494.8 -2126.5 -497.3 -2126.5 -501.2 b -2126.5 -505.1 -2129 -507.3 -2132.7 -507.4 b -2136.4 -507.5 -2139.2 -505.7 -2139.2 -501.2 b -2139.3 -496.8 -2136.5 -494.8 -2133 -494.8 {\\1c&HD6C895&} m -2289.2 -405.7 b -2290 -415.8 -2280.5 -425.3 -2274.4 -427.8 b -2279.1 -435.4 -2282.9 -445.1 -2274.2 -455.1 b -2265.6 -465.1 -2248.8 -462.4 -2243.4 -461.5 b -2243.1 -468 -2244.2 -480.7 -2230.8 -485.6 b -2217.4 -490.5 -2204.2 -479.7 -2200 -474.8 b -2196.2 -480 -2183.7 -490 -2171.7 -485.8 b -2159.7 -481.6 -2159.1 -470.9 -2158.8 -463 b -2150.7 -465.7 -2138.2 -466 -2129.1 -457.9 b -2119.9 -449.9 -2125.4 -440.1 -2128.5 -434.5 b -2122.8 -433 -2114.2 -426.1 -2114.1 -418.1 b -2114 -410.1 -2125 -401.4 -2130.9 -398.1 b -2125.8 -394.4 -2115.1 -378.2 -2120.4 -368.3 b -2125.8 -358.4 -2139.6 -356.9 -2145.3 -356.5 b -2145.6 -350.7 -2143.1 -341.2 -2150.9 -335.4 b -2158.8 -329.6 -2170.3 -331.9 -2175.6 -334.3 b -2179.6 -331 -2184.4 -326.7 -2193 -327.9 b -2201.6 -329.1 -2204.8 -334.4 -2208.4 -338.8 b -2212.6 -335.1 -2226.2 -324.3 -2237.4 -328.5 b -2248.6 -332.6 -2249.1 -344.5 -2249.7 -350.5 b -2256.7 -349.5 -2269.2 -349.1 -2277.4 -359.2 b -2285.6 -369.2 -2277.1 -383.4 -2272.6 -388.9 b -2278.8 -391.5 -2288.4 -395.7 -2289.2 -405.7 m -2249.7 -377.1 b -2241.8 -363 -2225.3 -370.3 -2218.8 -372.8 b -2218.9 -366.1 -2215.8 -348.3 -2200.1 -348.5 b -2184.4 -348.6 -2183.4 -365.1 -2182.7 -374.3 b -2175.7 -372.5 -2160.7 -364.5 -2152.9 -380.3 b -2145.2 -396.1 -2160.4 -400.6 -2168.1 -405.4 b -2159.9 -409.9 -2146.2 -418.8 -2153.3 -431.9 b -2160.5 -445.1 -2176.1 -440 -2183.3 -435.9 b -2185 -443.1 -2186.9 -460 -2201.6 -459.4 b -2216.2 -458.8 -2219.1 -444.5 -2218.8 -433.4 b -2226.2 -437 -2242.4 -442.6 -2249.7 -430.4 b -2257 -418.2 -2246.5 -408 -2239 -404.2 b -2245.8 -399.5 -2257.6 -391.2 -2249.7 -377.1 {\\p0}`;

/**
 * Generate the ASS dialogue line for the AnimeGATE logo
 * @throws Error if config is invalid
 */
export function generateLogo(config: LogoConfig): string {
  // Validate input
  const validation = validateLogoConfig(config);
  if (!validation.success) {
    throw new Error(`Invalid logo config: ${validation.error}`);
  }

  // Scale 7 for 1080p, 14 for 4K
  const scale =
    config.width > ASS_CONFIG.LOGO_4K_THRESHOLD
      ? ASS_CONFIG.LOGO_SCALE_4K
      : ASS_CONFIG.LOGO_SCALE_1080P;

  // Position scales with the logo
  const posX = scale * 7;
  const posY = scale * 7;

  return `Dialogue: 0,${ASS_CONFIG.TIMING.START},${ASS_CONFIG.TIMING.LOGO_END},AnimeGate,Logo,0,0,0,,{\\fscx${scale}\\fscy${scale}\\pos(${posX},${posY})\\an5\\shad0\\1a&H40&\\3a&HFF&\\p1}${LOGO_SVG_PATH}`;
}

// Re-export types for convenience
export type { TabelkaConfig, LogoConfig };
